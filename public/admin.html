<!DOCTYPE html>
<html>
<head>
  <title>asterisk Admin Dashboard</title>
  <style>
    body { font-family: monospace; background:#111; color:#eee; margin:0; padding:20px; }
    h2 { margin-bottom:10px; }
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { border:1px solid #444; padding:5px; text-align:left; }
    button { padding:3px 6px; background:#e74c3c; color:#fff; border:none; cursor:pointer; border-radius:3px; }
  </style>
</head>
<body>
  <h2>Admin Dashboard</h2>
  <table>
    <thead>
      <tr>
        <th>Report ID</th>
        <th>Reporter</th>
        <th>Reported User</th>
        <th>Message</th>
        <th>Reason</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="report-table"></tbody>
  </table>

  <script src="/socket.io/socket.io.js"></script>
<script>
  const adminKey = prompt("Enter admin secret:");

  if (!adminKey) {
    alert("Admin key required!");
    throw new Error("Admin key not provided");
  }

  const socket = io({
    transports: ["websocket"],
    auth: { admin: true, key: adminKey }
  });

  const table = document.getElementById('report-table');

  socket.on('connect', () => {
    console.log("Connected to server!");
  });

  socket.on('connect_error', (err) => {
    alert("Connection failed: " + err.message);
  });

  socket.on('reports', reports => {
    if (!reports || reports.length === 0) {
      alert("No reports found or you are not an admin.");
      return;
    }

    table.innerHTML = '';
    reports.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.reporter_id}</td>
        <td>${r.reported_user_id}</td>
        <td>${r.message || '[message deleted]'}</td>
        <td>${r.reason}</td>
        <td><button onclick="banUser('${r.reported_user_id}')">Ban</button></td>
        <td><button onclick="ignoreReport('${r.id}')">Ignore</button></td>
      `;
      table.appendChild(tr);
    });
  });

  function banUser(userId) {
    if (confirm(`Ban user ${userId}?`)) {
      socket.emit('banUser', { userId });
    }
  }

  function ignoreReport(reportId) {
    if (confirm(`Ignore report ${reportId}?`)) {
      socket.emit('ignoreReport', { reportId });
    }
  }

  // Only try to fetch reports if connected
  socket.on('connect', () => {
    socket.emit('getReports');
  });
</script>
</body>
</html>
